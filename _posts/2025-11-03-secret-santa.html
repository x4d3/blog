---
emoji: ðŸŽ…
layout: post
title: Secret Santa
category: Random
description: Description
---
<script src="{{"/assets/js/lz-string.js" | relative_url }}"></script>

<div id="app"></div>

<script>
    // --- Lehmer helpers ---
    function permutationToLehmerNumber(perm) {
        const n = perm.length;
        let lehmer = [];
        let items = Array.from({length: n}, (_, i) => i);
        for (let i = 0; i < n; i++) {
            const idx = items.indexOf(perm[i]);
            lehmer.push(idx);
            items.splice(idx, 1);
        }
        let num = 0, f = 1;
        for (let i = n - 1; i >= 0; i--) {
            num += lehmer[i] * f;
            f *= (n - i);
        }
        return num;
    }

    function lehmerNumberToPermutation(num, n) {
        let lehmer = Array(n).fill(0);
        for (let i = 1; i <= n; i++) {
            lehmer[n - i] = num % i;
            num = Math.floor(num / i);
        }
        let items = Array.from({length: n}, (_, i) => i);
        let perm = [];
        for (let i = 0; i < n; i++) {
            perm.push(items.splice(lehmer[i], 1)[0]);
        }
        return perm;
    }

    function randomPermutation(n) {
        const indices = Array.from({length: n}, (_, i) => i);
        for (let i = indices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [indices[i], indices[j]] = [indices[j], indices[i]];
        }
        return indices;
    }

    // --- URL helpers ---
    function updateURLWithParticipants(participants) {
        const encoded = LZString144.compressToEncodedURIComponent(participants.join('|'));
        const url = new URL(window.location);
        url.searchParams.set('list', encoded);
        url.searchParams.delete('v');
        url.searchParams.delete('p');
        window.history.replaceState({}, '', url);
    }

    function updateURLWithLehmer(participants, indices) {
        const lehmerNum = permutationToLehmerNumber(indices);
        const listEncoded = LZString144.compressToEncodedURIComponent(participants.join('|'));
        const lehmerEncoded = LZString144.compressToEncodedURIComponent(lehmerNum.toString());
        const url = new URL(window.location);
        url.searchParams.set('list', listEncoded);
        url.searchParams.set('p', lehmerEncoded);
        url.searchParams.delete('v');
        window.history.replaceState({}, '', url);
    }

    // --- UI helpers ---
    function renderDrawUI(container, participants) {
        container.innerHTML = `
            <label for="participants">Participants</label>
            <textarea id="participants" rows="10"></textarea>
            <button id="draw">Draw</button>
            <div id="links"></div>
        `;
        if (participants) {
            container.querySelector('#participants').value = participants.join('\n');
        }
    }

    function renderLinks(container, participants, shuffled) {
        container.innerHTML = '';
        const table = document.createElement('table');
        table.style.width = '100%';
        table.style.borderCollapse = 'collapse';

        // Header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['Recipient', 'Link', ''].forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            th.style.textAlign = 'left';
            th.style.padding = '4px 8px';
            headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Body
        const tbody = document.createElement('tbody');
        participants.forEach((recipient, idx) => {
            const i = shuffled.indexOf(recipient);
            const target = shuffled[(i + 1) % shuffled.length];
            const data = LZString144.compressToEncodedURIComponent(`${recipient}|${target}`);
            const url = `${window.location.origin}${window.location.pathname}?v=${data}`;

            const row = document.createElement('tr');

            // Recipient cell
            const tdRecipient = document.createElement('td');
            tdRecipient.textContent = recipient;
            tdRecipient.style.padding = '4px 8px';

            // Link cell
            const tdInput = document.createElement('td');
            const input = document.createElement('input');
            input.type = 'text';
            input.value = url;
            input.readOnly = true;
            input.style.width = '90%';
            tdInput.appendChild(input);
            tdInput.style.padding = '4px 8px';

            // Copy button cell
            const tdButton = document.createElement('td');
            const button = document.createElement('button');
            button.textContent = 'ðŸ“‹';
            addCopyToClipboardOnButton(button, () => url, "âœ…");
            tdButton.appendChild(button);
            tdButton.style.padding = '4px 8px';

            row.appendChild(tdRecipient);
            row.appendChild(tdInput);
            row.appendChild(tdButton);
            tbody.appendChild(row);
        });
        table.appendChild(tbody);

        container.appendChild(table);
    }


    function showViewMode(container, data) {
        const decoded = LZString144.decompressFromEncodedURIComponent(data);
        const [recipient, target] = decoded.split('|');
        container.innerHTML = `<h2>Hi ${recipient}</h2>
            <p>You have been assigned to give a gift to <b>${target}</b>.</p>`;
    }

    // --- Main ---
    document.addEventListener('DOMContentLoaded', function () {
        const params = new URLSearchParams(window.location.search);
        const data = params.get('v');
        const list = params.get('list');
        const lehmer = params.get('p');
        const container = document.getElementById('app');

        if (data) {
            showViewMode(container, data);
            return;
        }

        let participants = [];
        if (list) {
            participants = LZString144.decompressFromEncodedURIComponent(list).split('|');
        }
        renderDrawUI(container, participants);

        const participantsInput = container.querySelector('#participants');
        const drawButton = container.querySelector('#draw');
        const linksDiv = container.querySelector('#links');

        if (list && lehmer) {
            const lehmerNum = parseInt(LZString144.decompressFromEncodedURIComponent(lehmer), 10);
            const indices = lehmerNumberToPermutation(lehmerNum, participants.length);
            // Rebuild shuffled list from indices
            const shuffled = indices.map(i => participants[i]);
            renderLinks(linksDiv, participants, shuffled);

        }

        participantsInput.addEventListener('input', function () {
            const participants = participantsInput.value.split('\n').map(x => x.trim()).filter(Boolean);
            updateURLWithParticipants(participants);
            linksDiv.innerHTML = '';
        });

        drawButton.onclick = function () {
            const participants = participantsInput.value.split('\n').map(x => x.trim()).filter(Boolean);
            if (participants.length < 2) {
                linksDiv.innerHTML = '<p>Need at least 2 participants.</p>';
                return;
            }
            // Shuffle participants
            const shuffled = [...participants];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            // Save permutation as Lehmer number if needed
            const indices = shuffled.map(p => participants.indexOf(p));
            updateURLWithLehmer(participants, indices);
            renderLinks(linksDiv, participants, shuffled);
        };
    });
</script>
